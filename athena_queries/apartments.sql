WITH current_prices AS ( SELECT url, id, cijena, partitiondate as partitiondate FROM apartments ), previous_prices as ( SELECT id, cijena, min(partitiondate) as partitiondate FROM apartments group by 1,2 ) SELECT current.url, current.id, round((current.cijena - previous.cijena) / previous.cijena * 100, 2) as percent_change, current.cijena AS current_cijena, previous.cijena AS previous_cijena, current.partitiondate AS latest_date, previous.partitiondate as previous_date FROM current_prices AS current INNER JOIN previous_prices AS previous ON current.id = previous.id WHERE current.cijena != previous.cijena and date_parse(current.partitiondate, '%Y-%m-%d') >= current_date - interval '7' day and current.partitiondate > previous.partitiondate and round(current.cijena / previous.cijena, 2) > 0.2 ORDER BY percent_change, current.partitiondate desc